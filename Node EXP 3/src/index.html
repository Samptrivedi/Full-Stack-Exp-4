<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Booking System</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); text-align: center; width: 90%; max-width: 600px; }
        h1 { margin-bottom: 20px; color: #2c3e50; }
        .seats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin: 30px 0; }
        .seat { cursor: pointer; border: 2px solid; border-radius: 8px; font-weight: bold; padding: 10px; transition: all 0.2s ease; }
        .seat.available { border-color: #2ecc71; color: #2ecc71; }
        .seat.available:hover { background-color: #2ecc71; color: #fff; }
        .seat.locked { border-color: #f39c12; background-color: #f39c12; color: #fff; }
        .seat.booked { border-color: #e74c3c; background-color: #e74c3c; color: #fff; cursor: not-allowed; }
        .seat.selected { border-color: #3498db; background-color: #3498db; color: #fff; transform: scale(1.1); }
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.2s ease; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #reset-btn { background-color: #95a5a6; }
        #reset-btn:hover { background-color: #7f8c8d; }
        #status-message { margin-top: 25px; font-size: 1.1em; font-weight: 500; min-height: 25px; }
        .status-success { color: #2ecc71; }
        .status-error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h1>Select Your Seat</h1>
    <div id="seats-grid" class="seats-grid"></div>
    <div class="controls">
        <button id="confirm-btn" disabled>Confirm Booking</button>
        <button id="reset-btn">Reset Seats</button>
    </div>
    <p id="status-message"></p>
</div>

<script>
    const seatsGrid = document.getElementById('seats-grid');
    const confirmBtn = document.getElementById('confirm-btn');
    const resetBtn = document.getElementById('reset-btn');
    const statusMessage = document.getElementById('status-message');

    let selectedSeatId = null;

    // Fetch and display seats from the server
    const fetchSeats = async () => {
        try {
            const response = await fetch('/seats');
            const seats = await response.json();
            
            seatsGrid.innerHTML = ''; // Clear previous seats
            for (const seatId in seats) {
                const seat = seats[seatId];
                const seatElement = document.createElement('div');
                seatElement.classList.add('seat', seat.status);
                seatElement.dataset.seatId = seatId;
                seatElement.textContent = seatId;
                
                if (seat.status !== 'booked') {
                    seatElement.addEventListener('click', () => handleSeatClick(seatId, seat.status));
                }
                
                seatsGrid.appendChild(seatElement);
            }
        } catch (error) {
            updateStatus('Could not fetch seats.', 'error');
            console.error('Fetch seats error:', error);
        }
    };

    // Handle clicking on a seat
    const handleSeatClick = async (seatId, currentStatus) => {
        if (currentStatus === 'booked') return;
        
        // If a seat is already selected, unselect it visually first
        if (selectedSeatId) {
            const oldSeat = seatsGrid.querySelector(`[data-seat-id='${selectedSeatId}']`);
            if (oldSeat) oldSeat.classList.remove('selected');
        }

        // If clicking the same seat, deselect it
        if (selectedSeatId === seatId) {
            selectedSeatId = null;
            confirmBtn.disabled = true;
            updateStatus('Seat deselected.', 'success');
            return;
        }

        // Lock the new seat
        try {
            const response = await fetch(`/lock/${seatId}`, { method: 'POST' });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message);
            }

            updateStatus(data.message, 'success');
            selectedSeatId = seatId;

            // Visually update the selected seat
            const newSeat = seatsGrid.querySelector(`[data-seat-id='${seatId}']`);
            newSeat.classList.add('selected');
            
            confirmBtn.disabled = false;
            
        } catch (error) {
            updateStatus(error.message, 'error');
            console.error('Lock seat error:', error);
            fetchSeats(); // Refresh seats to show the correct state
        }
    };
    
    // Confirm booking for the selected seat
    confirmBtn.addEventListener('click', async () => {
        if (!selectedSeatId) return;

        try {
            const response = await fetch(`/confirm/${selectedSeatId}`, { method: 'POST' });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message);
            }

            updateStatus(data.message, 'success');
            selectedSeatId = null;
            confirmBtn.disabled = true;

        } catch (error) {
            updateStatus(error.message, 'error');
            console.error('Confirm booking error:', error);
        } finally {
            fetchSeats(); // Refresh seats to show final booked status or if the lock expired
        }
    });

    // Reset all seats
    resetBtn.addEventListener('click', async () => {
        try {
            await fetch('/reset', { method: 'POST' });
            updateStatus('All seats have been reset.', 'success');
            selectedSeatId = null;
            confirmBtn.disabled = true;
            fetchSeats();
        } catch (error) {
            updateStatus('Could not reset seats.', 'error');
            console.error('Reset seats error:', error);
        }
    });

    // Utility function to update the status message
    const updateStatus = (message, type) => {
        statusMessage.textContent = message;
        statusMessage.className = type === 'error' ? 'status-error' : 'status-success';
    };

    // Initial load and periodic refresh to handle lock expirations
    fetchSeats();
    setInterval(fetchSeats, 5000); // Refresh every 5 seconds
</script>

</body>
</html>